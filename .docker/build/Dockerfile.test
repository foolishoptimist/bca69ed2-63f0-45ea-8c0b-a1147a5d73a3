FROM composer:2.2 as deps
WORKDIR /app

COPY composer.json composer.lock /app/
RUN composer install  \
    --ignore-platform-reqs \
    --no-ansi \
    --no-autoloader \
    --no-interaction \
    --no-plugins \
    --no-scripts

COPY . /app/
RUN composer dump-autoload --optimize --classmap-authoritative

FROM php:8.1

# Configure PHP
COPY .docker/build/php.ini /usr/local/etc/php/

# Setup app
WORKDIR /app

COPY --from=deps /app /app

RUN php -r "file_exists('.env') || copy('.env.test', '.env');"